stages:
  - build
  - test
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  K8S_NAMESPACE: conscious-bridge

build-docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE

deploy-gke:
  stage: deploy
  image: google/cloud-sdk:alpine
  script:
    - echo "$GCP_SERVICE_KEY" | gcloud auth activate-service-account --key-file=-
    - gcloud container clusters get-credentials $CLUSTER_NAME --zone $CLUSTER_ZONE --project $GCP_PROJECT
    - kubectl set image deployment/conscious-bridge-reloaded bridge-app=$DOCKER_IMAGE -n $K8S_NAMESPACE
    - kubectl rollout status deployment/conscious-bridge-reloaded -n $K8S_NAMESPACE
  only:
    - main
